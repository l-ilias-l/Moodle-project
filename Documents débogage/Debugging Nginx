# Documentation de d√©bogage de l'installation Moodle sous Nginx

## Probl√®me rencontr√©

Lors de l'installation de Moodle (v4.4) sous Nginx, le CSS et le JavaScript ne se chargeaient pas correctement, provoquant une interface sans style. Le navigateur affichait des erreurs de type :

```
/theme/yui_combo.php?... -> ERR_CONTENT_DECODING_FAILED
```

En parall√®le, Moodle affichait √©galement l'erreur suivante apr√®s une r√©initialisation de base de donn√©es :

```
ERREUR : erreur de lecture de la base de donn√©es
```

## √âtapes de d√©pannage et solutions apport√©es

### 1. R√©initialisation de la base de donn√©es

Lors d'une mauvaise configuration initiale avec un utilisateur non souhait√© (moodleroot), il a √©t√© d√©cid√© de supprimer et de recr√©er proprement la base de donn√©es avec l'utilisateur souhait√© (`sysadmin`).

```bash
mysql -u root -p -e "DROP DATABASE moodle; CREATE DATABASE moodle DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
```

Cependant, Moodle ne pouvait plus acc√©der √† la base, et l'erreur "erreur de lecture de la base de donn√©es" persistait. Apr√®s v√©rification :

* L'utilisateur `sysadmin` n'avait pas les bons droits.
* Les tables n'√©taient pas cr√©√©es.

**Solution** : relancer correctement l'installation depuis le navigateur apr√®s avoir supprim√© le fichier `config.php`.

```bash
rm /var/www/html/moodle/config.php
```

Et suivre l'assistant d'installation via navigateur.

---

### 2. Probl√®me CSS/JS : fichiers non charg√©s

Les ressources CSS et JS de Moodle n‚Äô√©taient pas charg√©es. Apr√®s v√©rification :

* Les fichiers comme `/theme/styles.php` ou `/theme/yui_combo.php` √©taient renvoy√©s avec un mauvais encodage ou mal r√©√©crits.

#### Tentative 1 : zlib.output\_compression (√©chou√©e)

Ajout de :

```ini
zlib.output_compression = On
zlib.output_compression_level = 6
```

Dans `/etc/php/8.2/fpm/php.ini` + red√©marrage de PHP-FPM et Nginx ‚Üí √©chec.

#### ‚úÖ Solution retenue : configuration Nginx

La cause venait des **r√®gles de r√©√©criture manquantes dans Nginx**. Moodle a besoin de redirections particuli√®res pour g√©rer certains fichiers dynamiques.

##### üîß Configuration Nginx corrig√©e (Moodle √† la racine)

```nginx
server {
    listen 80;
    server_name 10.10.153.101;

    root /var/www/html/moodle;
    index index.php index.html index.htm;

    # R√©√©criture sp√©ciale Moodle
    rewrite ^/(.*\.php)(/)(.*)$ /$1?file=/$3 last;

    location / {
        try_files $uri $uri/ /index.php?q=$request_uri;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|otf|ttc|mp4|webm|ogg)$ {
        expires max;
        log_not_found off;
    }

    location ~ /\.ht {
        deny all;
    }
}
```

##### ‚úÖ √âtapes de finalisation

1. **Red√©marrer les services**

```bash
sudo nginx -t
sudo systemctl reload nginx
sudo systemctl restart php8.2-fpm
```

2. **Vider les caches Moodle**

```bash
sudo -u www-data php /var/www/html/moodle/admin/cli/purge_caches.php
```

3. **Forcer le rechargement du navigateur**

Ctrl+F5 ou vider le cache manuellement.

---

## R√©sultat

* Moodle fonctionne.
* L‚Äôinstallation a bien utilis√© l‚Äôutilisateur `sysadmin`.
* Le CSS/JS s‚Äôaffiche correctement.
* Aucune erreur restante dans les logs.

## Remarques finales

* Toujours bien s‚Äôassurer que la configuration Nginx est compatible avec Moodle (PHP dynamique, redirections).
* Supprimer le fichier `config.php` avant toute r√©installation.
* V√©rifier les droits utilisateurs sur la base de donn√©es.
* Ne pas oublier de purger les caches Moodle apr√®s chaque modification serveur.

